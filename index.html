<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Halma</title>

    <link rel="stylesheet" href="style/style.css">
</head>
<body>
    <div class="select-game-modal">
        <div class="select-game">
            <h3>Game Mode</h3>
            <form class="radio-container">
                <h4>B - Size : </h4>
                <label for="b-8">8</label>
                <input type="radio" name="b-size" id="b-8" value="8" checked="checked">
                <label for="b-10">10</label>
                <input type="radio" name="b-size" id="b-10" value="10">
                <label for="b-16">16</label>
                <input type="radio" name="b-size" id="b-16" value="16">
            </form>
            <form class="radio-container">
                <h4>T - Limit (in seconds): </h4>
                <input type="text" name="t-limit" id="t-limit" value="10">
            </form>
            <form class="radio-container">
                <h4>Select Player Color : </h4>
                <label for="h-merah">Merah</label>
                <input type="radio" name="h-player" id="h-merah" value="1" checked="checked">
                <label for="h-hijau">Hijau</label>
                <input type="radio" name="h-player" id="h-hijau" value="0">
                <label for="h-hijau">No Player</label>
                <input type="radio" name="h-player" id="h-no-player" value="-1">
            </form>
            <form class="radio-container">
                <h4>Select Bot Type : </h4>
                <label for="h-merah">Minimax</label>
                <input type="radio" name="bot-type" id="minimax" value="minimax" checked="checked">
                <label for="h-hijau">Minimax + Local Search</label>
                <input type="radio" name="bot-type" id="minimax-local-search" value="minimax-local-search">
            </form>
            <form class="radio-container play">
                <input type="button" id="play-button" value="Play">
            </form>
        </div>
    </div>
    <div class="select-game-modal" style="z-index: 999">
        <div class="select-game">
            <h3>CONGRATULATIONS</h3>
            <p id="player-wins">Player wins!</p>
            <p id="bot-move-count">Bot Move Count : </p>
        </div>
    </div>
    <div class="container">
        <div class="title">
            <h1>Halma</h1>
        </div>
        <div class="content">
            <div id="board">
                
            </div>
        </div>
    </div>

    <script src="js/Util.js"></script>
    <script src="js/GameState.js"></script>
    <script src="js/Minmax.js"></script>
    <script>
        var forms = null
        var bSize = null
        var tLImit = null
        var playerMode = null

        // /* Initial Matrix */
        // let matrix = [
        //     [1,1,1,0,0,0,0,0],
        //     [1,1,0,0,0,0,0,0],
        //     [1,1,0,0,0,0,0,0],
        //     [0,0,0,0,0,0,0,0],
        //     [0,0,0,0,0,0,0,0],
        //     [0,0,0,0,0,0,0,0],
        //     [0,0,0,0,0,2,2,2],
        //     [0,0,0,0,0,2,2,2],
        // ]

        // /* Matrix untuk state click */
        // let clickState = [
        //     [1,1,1,0,0,0,0,0],
        //     [1,1,0,0,0,0,0,0],
        //     [1,1,0,0,0,0,0,0],
        //     [0,0,0,0,0,0,0,0],
        //     [0,0,0,0,0,0,0,0],
        //     [0,0,0,0,0,0,0,0],
        //     [0,0,0,0,0,1,1,1],
        //     [0,0,0,0,0,1,1,1],
        // ]
        let gameState = null
        let userClicked = null
        let turn = 1
        let botMoveCount = 0

        /* Selected Cell */
        // let selectedCell = null

        const createBoard = (mat, clickmat, selectedCell, gameState, siz, playerMode, botType) => {
            const board = document.getElementById("board")
            if(siz == 8) {
                board.classList.add("board-8x8")
            } else if(siz == 10) {
                board.classList.add("board-10x10")
            } else {
                board.classList.add("board-16x16")
            }
            for(let i = 0; i < siz; i++) {
                
                for(let j = 0; j < siz; j++) {
                    let invert = false 
                    if((i + j) % 2 == 1) {
                        invert = true
                    }
                    const cell = createCell(mat[i][j], invert, siz)

                    const id = "id_" + i.toString(10) + "_" + j.toString(10)

                    cell.setAttribute("id", id)

                    board.appendChild(cell)

                    invert = !invert
                    
                    cell.addEventListener("click", async (e) => {
                        if(clickmat[i][j] == 1) {
                            for(let a = 0; a < siz; a++) {
                                for(let b = 0; b < siz; b++) {
                                    clickmat[a][b] = 0
                                }
                            }

                            clickmat[i][j] = 3

                            const overlay = document.createElement("div")
                            overlay.setAttribute("class", "selected-cell")
                            cell.appendChild(overlay)

                            const availablePos = findAvailablePositions(i, j, mat)
                            availablePos.forEach((value) => {
                                clickmat[value[0]][value[1]] = 2

                                let curCell = getCell(value[0], value[1])
                                const overlay = document.createElement("div")
                                overlay.setAttribute("class", "avail")
                                curCell.appendChild(overlay)
                            })

                            selectedCell = [i, j, mat[i][j]]
                        } else if(clickmat[i][j] == 2 || clickmat[i][j] == 3) {
                            moveToCell(mat, siz, selectedCell[0], selectedCell[1], i, j)
                            
                            if(clickmat[i][j] == 2) {
                                mat[i][j] = selectedCell[2]
                                mat[selectedCell[0]][selectedCell[1]] = 0
                            }

                            selectedCell = null 
                            if (clickmat[i][j] !== 3) {
                                // console.log(clickmat[i][j])
                                // cek state terminal
                                let terminalStatus = terminalState(gameState)
                                console.log("botMoveCount : " + botMoveCount)
                                if(terminalStatus == 1) {
                                    document.getElementsByClassName("select-game-modal")[1].setAttribute("style", "display: block; z-index: 999;")
                                    document.getElementById("player-wins").innerHTML = "Player one wins!"
                                    document.getElementById("bot-move-count").innerHTML = "Bot move count: " + botMoveCount
                                } else if(terminalStatus == 2) {
                                    document.getElementsByClassName("select-game-modal")[1].setAttribute("style", "display: block; z-index: 999;")
                                    document.getElementById("player-wins").innerHTML = "Player two wins!"
                                    document.getElementById("bot-move-count").innerHTML = "Bot move count: " + botMoveCount
                                } else {
                                    // kalo tidak terminal lanjut
                                    await new Promise(r => setTimeout(r, 200))
                                    if (playerMode !== -1) {
                                        if (turn === 1) {
                                            botMove(gameState, botType)
                                            botMoveCount++
                                        }
                                    } else {
                                        gameState.player = turn + 1
                                        if (turn === 1) {
                                            botMove(gameState, "minimax")
                                            botMoveCount++
                                        } else {
                                            botMove(gameState, "minimax-local-search")
                                            botMoveCount++
                                        }
                                    }
                                    // if (turn === 1) {
                                    //     if (playerMode === -1) {
                                    //         botMove(gameState, "minimax-local-search")
                                    //         gameState.player = 2 - turn
                                    //     } else {
                                    //         botMove(gameState, botType)
                                    //     }
                                    // }
                                    turn = (turn + 1) % 2

                                }
                            }
                            for(let a = 0; a < siz; a++) {
                                for(let b = 0; b < siz; b++) {
                                    if(mat[a][b] > 0) {
                                        clickmat[a][b] = 1
                                    }
                                }
                            }

                            document.querySelectorAll('.avail').forEach((node) => {
                                node.remove()
                            })
                            
                            // await new Promise(r => setTimeout(r, 1000))
                        }


                    })
                }
            }
        }
        playButton = document.getElementById("play-button").addEventListener('click', () => {
            forms = document.getElementsByClassName("radio-container")
            bSize = Array.from(forms[0].childNodes).filter((child) => child.checked)[0].value
            tLimit = parseInt(document.getElementById("t-limit").value)
            playerMode = parseInt(Array.from(forms[2]).filter((child) => child.checked)[0].value)
            botType = Array.from(forms[3]).filter((child) => child.checked)[0].value
            // console.log(playerMode)
            botTurn = playerMode === 0 || playerMode === -1 ? 1 : 2
            console.log(botTurn)    
            gameState = new GameState(null, bSize, botTurn)
            // botMove(gameState, botType)
            createBoard(gameState.board, gameState.clickState, gameState.selectedCell, gameState, bSize, playerMode, botType)
            if (playerMode === 0) {
                turn = 0
                botMove(gameState, botType)
            }
            if (playerMode === -1) {
                botMove(gameState, "minimax")
            }
            // console.log('udah')
            document.getElementsByClassName("select-game-modal")[0].setAttribute("style", "display: none;")
            document.getElementsByClassName("select-game-modal")[1].setAttribute("style", "display: none;")
        })

    </script>
</body>

<script>

</script>
</html>